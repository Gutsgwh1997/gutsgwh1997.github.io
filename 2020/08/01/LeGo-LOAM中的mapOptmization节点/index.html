<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Mist","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="LeGo-LOAM中的mapOptmization节点LeGo-LOAM是在LOAM基础上改进的激光雷达定位与建图方法，它对地面点进行了优化、提出了两步LM优化算法，加入了闭环检测和全局因子图优化等。本系列博客只说明了关键代码的功能实现，以及一些关键地方的数学推导，详细的解释都写在了代码注释中，注释后的代码在融合相机后会传到github。同时也列出来一些问题提醒自己有条件时实际去验证。">
<meta property="og:type" content="article">
<meta property="og:title" content="LeGo-LOAM中的mapOptmization节点">
<meta property="og:url" content="http://yoursite.com/2020/08/01/LeGo-LOAM%E4%B8%AD%E7%9A%84mapOptmization%E8%8A%82%E7%82%B9/index.html">
<meta property="og:site_name" content="GWH Blog">
<meta property="og:description" content="LeGo-LOAM中的mapOptmization节点LeGo-LOAM是在LOAM基础上改进的激光雷达定位与建图方法，它对地面点进行了优化、提出了两步LM优化算法，加入了闭环检测和全局因子图优化等。本系列博客只说明了关键代码的功能实现，以及一些关键地方的数学推导，详细的解释都写在了代码注释中，注释后的代码在融合相机后会传到github。同时也列出来一些问题提醒自己有条件时实际去验证。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-07-31T16:02:36.000Z">
<meta property="article:modified_time" content="2020-07-31T16:05:57.278Z">
<meta property="article:author" content="陌上&amp;烟雨">
<meta property="article:tag" content="SLAM">
<meta property="article:tag" content="LeGo-LOAM">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2020/08/01/LeGo-LOAM%E4%B8%AD%E7%9A%84mapOptmization%E8%8A%82%E7%82%B9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>LeGo-LOAM中的mapOptmization节点 | GWH Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">GWH Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    

  <a href="https://github.com/Gutsgwh1997" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/01/LeGo-LOAM%E4%B8%AD%E7%9A%84mapOptmization%E8%8A%82%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E5%A4%B4%E5%83%8F.jpeg">
      <meta itemprop="name" content="陌上&烟雨">
      <meta itemprop="description" content="这知识，它不进脑子啊！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GWH Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          LeGo-LOAM中的mapOptmization节点
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-08-01 00:02:36 / 修改时间：00:05:57" itemprop="dateCreated datePublished" datetime="2020-08-01T00:02:36+08:00">2020-08-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/" itemprop="url" rel="index"><span itemprop="name">SLAM</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/LOAM/" itemprop="url" rel="index"><span itemprop="name">LOAM</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SLAM/LOAM/LeGo-LOAM/" itemprop="url" rel="index"><span itemprop="name">LeGo-LOAM</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>10 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="LeGo-LOAM中的mapOptmization节点"><a href="#LeGo-LOAM中的mapOptmization节点" class="headerlink" title="LeGo-LOAM中的mapOptmization节点"></a>LeGo-LOAM中的mapOptmization节点</h2><p>LeGo-LOAM是在LOAM基础上改进的激光雷达定位与建图方法，它对地面点进行了优化、提出了两步LM优化算法，加入了闭环检测和全局因子图优化等。<br>本系列博客只说明了关键代码的功能实现，以及一些关键地方的数学推导，详细的解释都写在了代码注释中，注释后的代码在融合相机后会传到github。同时也列出来一些问题提醒自己有条件时实际去验证。</p>
<a id="more"></a>


<h3 id="这个模块接收5种消息"><a href="#这个模块接收5种消息" class="headerlink" title="这个模块接收5种消息"></a>这个模块接收5种消息</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从featureAssociation节点中接收的投影到结束点时刻Lidar坐标系下的去畸变次极大边线点云</span></span><br><span class="line">subLaserCloudCornerLast = nh.subscribe&lt;sensor_msgs::PointCloud2&gt;(<span class="string">"/laser_cloud_corner_last"</span>, <span class="number">2</span>, &amp;mapOptimization::laserCloudCornerLastHandler, <span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// 从featureAssociation节点中接收的投影到结束点时刻Lidar坐标系下的去畸变次极小平面点云</span></span><br><span class="line">subLaserCloudSurfLast = nh.subscribe&lt;sensor_msgs::PointCloud2&gt;(<span class="string">"/laser_cloud_surf_last"</span>, <span class="number">2</span>, &amp;mapOptimization::laserCloudSurfLastHandler, <span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// 从featureAssociation节点中接收的外点点云——非地面无效分割点云(5倍降采样后)</span></span><br><span class="line">subOutlierCloudLast = nh.subscribe&lt;sensor_msgs::PointCloud2&gt;(<span class="string">"/outlier_cloud_last"</span>, <span class="number">2</span>, &amp;mapOptimization::laserCloudOutlierLastHandler, <span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// 从featureAssociation节点中接收的当前帧位姿，是当前帧点云结束点时刻Lidar坐标系到world系的位姿变换</span></span><br><span class="line">subLaserOdometry = nh.subscribe&lt;nav_msgs::Odometry&gt;(<span class="string">"/laser_odom_to_init"</span>, <span class="number">5</span>, &amp;mapOptimization::laserOdometryHandler, <span class="keyword">this</span>);</span><br><span class="line"><span class="comment">// 接收原始的IMU消息</span></span><br><span class="line">subImu = nh.subscribe&lt;sensor_msgs::Imu&gt;(imuTopic, <span class="number">50</span>, &amp;mapOptimization::imuHandler, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>

<p>这里的消息接收函数都比较简单，都是将接收到的消息存入成员变量。</p>
<h3 id="这个模块有三个线程"><a href="#这个模块有三个线程" class="headerlink" title="这个模块有三个线程"></a>这个模块有三个线程</h3><ul>
<li>主线程：sweep到local_map的优化，ISAM2增量式更新（这个线程添加连续两点云帧之间的约束）；</li>
<li>闭环线程：检测闭环帧，ICP配准当前帧与历史帧的local_map，ISAM2增量式更新（这个线程添加回环约束）；</li>
<li>可视化线程：publish全局地图、保存地图到硬盘；</li>
</ul>
<h3 id="1、主线程"><a href="#1、主线程" class="headerlink" title="1、主线程"></a>1、主线程</h3><p>主线程的主要过程如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 判断如果3个点云消息和1个里程计消息接收成功，且时间戳一致</span></span><br><span class="line">    <span class="comment">// 这里就将频率不一致的里程计消息和点云消息时间戳对齐了</span></span><br><span class="line">      ...</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">    <span class="comment">// 判断如果当前接收里程计消息时间戳相比上一Mapping的时间戳的间隔时间大于等于设置的建图时间间隔mappingProcessInterval=0.3s，则进行本次mapping</span></span><br><span class="line">    <span class="keyword">if</span> (timeLaserOdometry - timeLastProcessing &gt;= mappingProcessInterval) &#123;</span><br><span class="line">      timeLastProcessing = timeLaserOdometry;</span><br><span class="line">      <span class="comment">// 基于匀速模型，为待优化变量transformTobeMapped赋一个初始值</span></span><br><span class="line">      transformAssociateToMap();</span><br><span class="line">      <span class="comment">// 构造当前帧对应的由关键帧构成的local_map</span></span><br><span class="line">      extractSurroundingKeyFrames();</span><br><span class="line">      <span class="comment">// 将接收到的lessSharp点集、lessFlat点集和outlierCloudl点集降采样</span></span><br><span class="line">      downsampleCurrentScan();</span><br><span class="line">      <span class="comment">// 当前帧与local_map进行匹配、优化</span></span><br><span class="line">      scan2MapOptimization();</span><br><span class="line">      <span class="comment">// 全局位姿优化，添加关键帧、增量式更新ISAM2，求解最新关键帧的位姿</span></span><br><span class="line">      saveKeyFramesAndFactor(); </span><br><span class="line">      <span class="comment">// 找到闭环并进行闭环帧优化后，在这里更新所有关键帧点云的位姿</span></span><br><span class="line">      correctPoses();</span><br><span class="line">      <span class="comment">// 将当前帧Mapping修正后的全局位姿transformAftMapped发布出去</span></span><br><span class="line">      publishTF();</span><br><span class="line">      <span class="comment">// 将存储关键帧位姿的点云cloudKeyPoses3D发布出去，将点云laserCloudSurfFromMapDS发布出去</span></span><br><span class="line">      publishKeyPosesAndFrames();</span><br><span class="line">      <span class="comment">// 清空近邻地图特征点云</span></span><br><span class="line">      clearCloud();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>mapOptmization节点的作用就是将一帧点云(sweep)与local_map匹配，得到更加准确的全局位姿，并建立全局一致的点云地图。</p>
<h4 id="1-1、transformAssociateToMap"><a href="#1-1、transformAssociateToMap" class="headerlink" title="1.1、transformAssociateToMap()"></a>1.1、transformAssociateToMap()</h4><p>基于匀速模型，为待优化变量transformTobeMapped赋一个初始值，这里先说明一下这三个变量的含义：</p>
<ul>
<li>transformSum[]是Odometry模块计算出来的当前帧结束点时刻Lidar坐标系到世界坐标系的变换 $T_{cur-end}^{world}$;</li>
<li>transformBefMapped[]是mapping之前的Odometry计算的世界坐标系下的转换矩阵$T_{bef-map}^{world}$；</li>
<li>transformAftMapped[]是mapping微调之后的转换矩阵$T_{aft-map}^{world}$；</li>
</ul>
<p>这里要给优化变量transformTobeMapped[]赋一个初始值：$T_{tobe}^{world} = T_{cur-end}^{world}  (T_{bef-map}^{world})^{-1}T_{aft-map}^{world}$</p>
<p>从这个变换矩阵中，能推导出的旋转与平移为：<br>$$<br>\begin{aligned}<br>R_{tobe}^{world} &amp;= R_{cur-end}^{world}(R_{bef-map}^{world})^{-1}R_{aft-map}^{world} \\<br>t_{tobe}^{world} &amp;= t_{cur-end}^{world}-R_{cur-end}^{world}(R_{bef-map}^{world})^{-1}(t_{bef-map}^{world} - t_{aft-map}^{world})<br>\end{aligned}<br>$$<br>这里的旋转项能和代码完全对应，<font color=red>但是平移项对应不上！</font>原始代码中的平移项这样计算：<br>$$<br>t_{tobe}^{world} = t_{aft-map}^{world} - R_{tobe}^{world}(R_{cur-end}^{world})^{-1}(t_{bef-map}^{world} - t_{cur-end}^{world})<br>$$<br>从推导中看，原始代码中没理解出来是什么含义。</p>
<h4 id="1-2、extractSurroundingKeyFrames"><a href="#1-2、extractSurroundingKeyFrames" class="headerlink" title="1.2、extractSurroundingKeyFrames()"></a>1.2、extractSurroundingKeyFrames()</h4><p>构造当前帧对应的由关键帧构成的local_map，这个local_map就是用来做配准的。这里当前帧与关键帧不是一个概念，只有满足一定条件的当前帧才能成为关键帧，关键帧的添加在<code>saveKeyFramesAndFactor()</code>函数中。</p>
<p>LeGo-LOAM提供了一个比较粗糙的闭环功能，若开启闭环功能，local_map是由一组<strong>时间近邻</strong>关键帧构成的，即由距离当前帧时间最近的50帧关键帧构成。若关闭闭环功能，local_map是由一组<strong>空间近邻</strong>关键帧构成的，即由距离当前帧半径50m内的关键帧构成的。不同于LOAM中维护空间范围划分的滑动窗口，LeGo-LOAM这里就比较直接干脆。</p>
<p>满足条件的关键帧的次极大边线点集拼凑起来，构成了local_map中的次极大边线点集（laserCloudCornerFromMapDS）；满足条件的关键帧的次极小平面点集与外点点集拼凑在一块，构成了local_map中的次极小平面点集（laserCloudSurfFromMapDS）。<font color=red>这里是有点问题的！</font>mapOptmization节点接收到的次极大边线点集与次极小平面点集都是经过去畸变处理的，但是外点点集并没有去畸变，<strong>所以次极小平面点集与外点点集的参考坐标不一致</strong>，代码中将这俩点云直接拼凑起来。</p>
<h4 id="1-3、scan2MapOptimization"><a href="#1-3、scan2MapOptimization" class="headerlink" title="1.3、scan2MapOptimization()"></a>1.3、scan2MapOptimization()</h4><p>当前帧与local_map进行匹配、优化，这是一个主力函数，对应LOAM论文中Lidaring Mapping那段。首先只有local_map中的lessSharp以及lessFlat点集够大时（分别大于10,100）才进行匹配优化。</p>
<p><code>cornerOptimization()</code>函数从局部地图lessSharp点集中查找当前帧LessSharp特征点的匹配线（通过PCA的方法），并计算匹配距离。LOAM原论文中说，Mapping模块提取二倍Odometry模块提取的边线特征点，Lego-LOAM这里对降采样后的当前帧的每一个次极大边线点都去寻求匹配线。这里寻找匹配线也是LOAM中的方法，不同于featureAssociation节点，此节点采用PCA的方法，对当前帧中的一个次极大边线点$p_a$，在local_map的次极大边线点云中寻找5个距离$p_a$最近的点，计算这5个点的均值和协方差矩阵，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> cx = <span class="number">0</span>, cy = <span class="number">0</span>, cz = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j++)&#123;</span><br><span class="line">     cx += laserCloudCornerFromMapDS-&gt;points[pointSearchInd[j]].x;</span><br><span class="line">     cy += laserCloudCornerFromMapDS-&gt;points[pointSearchInd[j]].y;</span><br><span class="line">     cz += laserCloudCornerFromMapDS-&gt;points[pointSearchInd[j]].z;</span><br><span class="line">&#125;</span><br><span class="line">cx /= <span class="number">5</span>; cy /= <span class="number">5</span>; cz /= <span class="number">5</span>;</span><br><span class="line"><span class="keyword">float</span> a11 = <span class="number">0</span>, a12 = <span class="number">0</span>, a13 = <span class="number">0</span>, a22 = <span class="number">0</span>, a23 = <span class="number">0</span>, a33 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j++)&#123;</span><br><span class="line">    <span class="keyword">float</span> ax = laserCloudCornerFromMapDS-&gt;points[pointSearchInd[j]].x - cx;</span><br><span class="line">    <span class="keyword">float</span> ay = laserCloudCornerFromMapDS-&gt;points[pointSearchInd[j]].y - cy;</span><br><span class="line">    <span class="keyword">float</span> az = laserCloudCornerFromMapDS-&gt;points[pointSearchInd[j]].z - cz;</span><br><span class="line">    a11 += ax * ax; a12 += ax * ay; a13 += ax * az;</span><br><span class="line">    a22 += ay * ay; a23 += ay * az; a33 += az * az;</span><br><span class="line">&#125;</span><br><span class="line">a11 /= <span class="number">5</span>; a12 /= <span class="number">5</span>; a13 /= <span class="number">5</span>;</span><br><span class="line">a22 /= <span class="number">5</span>; a23 /= <span class="number">5</span>; a33 /= <span class="number">5</span>;</span><br><span class="line">matA1.at&lt;<span class="keyword">float</span>&gt;(<span class="number">0</span>, <span class="number">0</span>) = a11; matA1.at&lt;<span class="keyword">float</span>&gt;(<span class="number">0</span>, <span class="number">1</span>) = a12; matA1.at&lt;<span class="keyword">float</span>&gt;(<span class="number">0</span>, <span class="number">2</span>) = a13;</span><br><span class="line">matA1.at&lt;<span class="keyword">float</span>&gt;(<span class="number">1</span>, <span class="number">0</span>) = a12; matA1.at&lt;<span class="keyword">float</span>&gt;(<span class="number">1</span>, <span class="number">1</span>) = a22; matA1.at&lt;<span class="keyword">float</span>&gt;(<span class="number">1</span>, <span class="number">2</span>) = a23;</span><br><span class="line">matA1.at&lt;<span class="keyword">float</span>&gt;(<span class="number">2</span>, <span class="number">0</span>) = a13; matA1.at&lt;<span class="keyword">float</span>&gt;(<span class="number">2</span>, <span class="number">1</span>) = a23; matA1.at&lt;<span class="keyword">float</span>&gt;(<span class="number">2</span>, <span class="number">2</span>) = a33;</span><br><span class="line"><span class="comment">// 求协防差矩阵的特征值与特征向量</span></span><br><span class="line">cv::eigen(matA1, matD1, matV1);</span><br></pre></td></tr></table></figure>

<p>A-LOAM的代码中使用Eigen来帮助计算，代码会简洁许多：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Eigen::Vector3d&gt; nearCorners;</span><br><span class="line"><span class="function">Eigen::Vector3d <span class="title">center</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j++) &#123;</span><br><span class="line">    <span class="function">Eigen::Vector3d <span class="title">tmp</span><span class="params">(laserCloudCornerFromMap-&gt;points[pointSearchInd[j]].x,</span></span></span><br><span class="line"><span class="function"><span class="params">                        laserCloudCornerFromMap-&gt;points[pointSearchInd[j]].y,</span></span></span><br><span class="line"><span class="function"><span class="params">                        laserCloudCornerFromMap-&gt;points[pointSearchInd[j]].z)</span></span>;</span><br><span class="line">    center = center + tmp;</span><br><span class="line">    nearCorners.push_back(tmp);</span><br><span class="line">&#125;</span><br><span class="line">center = center / <span class="number">5.0</span>;</span><br><span class="line"><span class="comment">// 计算这个5个最近邻点的协方差矩阵</span></span><br><span class="line">Eigen::Matrix3d covMat = Eigen::Matrix3d::Zero();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j++) &#123;</span><br><span class="line">    Eigen::Matrix&lt;<span class="keyword">double</span>, <span class="number">3</span>, <span class="number">1</span>&gt; tmpZeroMean = nearCorners[j] - center;</span><br><span class="line">    covMat = covMat + tmpZeroMean * tmpZeroMean.transpose();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Eigen::SelfAdjointEigenSolver&lt;Eigen::Matrix3d&gt; <span class="title">saes</span><span class="params">(covMat)</span></span>;</span><br></pre></td></tr></table></figure>

<p>边线点找寻匹配的线，若这5个点能构成边线，协方差矩阵的特征值只有一个比较大（代码里会验证最大的特征值是否大于3倍的次极大的特征值），则这个最大的特征值对应的特征向量就是匹配线的方向、这5个点的均值就作为直线上的点，如此边线找到了，点到直线的距离约束就可建立了。</p>
<p><code>surfOptimization()</code>函数从局部地图lessFlat点集中查找当前帧lessFloat特征点的匹配平面（通过拟合平面的方法）。假设平面不通过原点，则平面的一般方程为Ax + By + Cz + 1 = 0，用这个假设可以少算一个参数，提高效率。对当前帧中的一个次极小平面点$p_b$，在local_map的次极小平面点云中寻找5个距离$p_b$最近的点，使用这5个点拟合出一个平面出来。若拟合的平面效果较好（将这5个点分别代入平面方程，看误差是否超过0.2），点到平面的距离约束就可建立了。</p>
<p>调用<code>LMOptimization()</code>函数，Gauss-Newton优化算法求解建立的约束的增量方程。具体的推导新开一节，统一整理。</p>
<h4 id="1-4、saveKeyFramesAndFactor"><a href="#1-4、saveKeyFramesAndFactor" class="headerlink" title="1.4、saveKeyFramesAndFactor()"></a>1.4、saveKeyFramesAndFactor()</h4><p>此函数添加关键帧，并进行全局的因子图优化。若当前帧距离上一关键帧的位移量超过0.3m，当前帧被定义为关键帧，首先将当前帧的位姿图约束添加到因子图中，增量式更新iSAM2对象，将更新后的当前帧位姿保存到关键帧队列，当前帧对应的点云也保存到关键帧队列，供给回环检测线程使用。这里向因子图添加约束时，Lego-LOAM又将坐标系转换到原来的x轴向前，y轴向左，z轴向上的坐标下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 因子图中增加一个先验因子，将其设为原点 <span class="doctag">TODO:</span>:这里为什么要做这么个变换，后来还费事变换回去？</span></span><br><span class="line"><span class="comment">// 传感器本身的坐标系是x轴向前，y轴向左，z轴向上的右手坐标系，lego-loam将其转换为z轴向前，x轴向左，y轴向上的右手坐标系</span></span><br><span class="line"><span class="comment">// 整个处理都是在z轴向前，x轴向左，y轴向上的右手坐标系下，在这个坐标系下：</span></span><br><span class="line"><span class="comment">// roll = transformTobeMapped[0]; pitch = transformTobeMapped[1]; yaw = transformTobeMapped[2];  R_cur^&#123;world&#125; = Ry(pitch) * Rx(roll) * Rz(yaw)</span></span><br><span class="line"><span class="comment">// 这里的旋转Pose3,平移Point3又变换到原来的坐标系下了，Pose3 = Rz(pitch) * Ry(roll) * Rx(yaw)</span></span><br><span class="line">gtSAMgraph.add(PriorFactor&lt;Pose3&gt;(<span class="number">0</span>,Pose3(Rot3::RzRyRx(transformTobeMapped[<span class="number">2</span>],transformTobeMapped[<span class="number">0</span>], transformTobeMapped[<span class="number">1</span>]),Point3(transformTobeMapped[<span class="number">5</span>],transformTobeMapped[<span class="number">3</span>],transformTobeMapped[<span class="number">4</span>])), priorNoise));</span><br><span class="line"><span class="comment">// 给添加进去的因子一个初始值，initialEstimate的数据类型是Values,其实就是一个map，这里在0对应的值下面保存了一个Pose3</span></span><br><span class="line">initialEstimate.insert(<span class="number">0</span>,Pose3(Rot3::RzRyRx(transformTobeMapped[<span class="number">2</span>],transformTobeMapped[<span class="number">0</span>],transformTobeMapped[<span class="number">1</span>]),Point3(transformTobeMapped[<span class="number">5</span>], transformTobeMapped[<span class="number">3</span>], transformTobeMapped[<span class="number">4</span>])));</span><br></pre></td></tr></table></figure>

<h4 id="1-5、correctPoses"><a href="#1-5、correctPoses" class="headerlink" title="1.5、correctPoses()"></a>1.5、correctPoses()</h4><p>回环检测线程找到闭环并进行闭环帧优化后，在这个线程里更新所有关键帧点云的位姿。这里先将当前帧近邻特征点云队列清空，因为所有关键帧的位姿都会更新，再搜寻当前帧50m半径范围内的关键帧时会发生点变化，所以全部清空，完全从新构造local_map。</p>
<h4 id="1-6、发布全局位姿、相关点云"><a href="#1-6、发布全局位姿、相关点云" class="headerlink" title="1.6、发布全局位姿、相关点云"></a>1.6、发布全局位姿、相关点云</h4><p><code>publishTf()</code>把当前帧Mapping修正后的全局位姿transformAftMapped发布出去；<code>publishKeyPosesAndFrames()</code>将存储关键帧位姿的点云cloudKeyPoses3D发布出，将点云laserCloudSurfFromMapDS(当前帧的近邻关键帧集合)发布出去。</p>
<h3 id="2、回环检测线程"><a href="#2、回环检测线程" class="headerlink" title="2、回环检测线程"></a>2、回环检测线程</h3><p>回环检测线程以1Hz的频率去检测闭环，Lego-LOAM中的闭环检测是基于里程计的几何关系的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loopClosureThread</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (loopClosureEnableFlag == <span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// 以1Hz的频率去检测回环</span></span><br><span class="line">  <span class="function">ros::Rate <span class="title">rate</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line">  <span class="keyword">while</span> (ros::ok())</span><br><span class="line">  &#123;</span><br><span class="line">    rate.sleep();</span><br><span class="line">    performLoopClosure();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>performLoopClosure()</code>函数先调用<code>detectLoopClosure()</code>函数从历史关键帧轨迹中找寻回环帧，流程如下：</p>
<ol>
<li>使用历史关键帧位置构建kdtree，从kdtree中搜素距离当前帧位置7.0m范围内的历史帧;</li>
<li>将当前帧的lessSharp与lessFlat点合并构成latestSurfKeyFrameCloud;</li>
<li>在满足条件的历史回环帧周围(前后25帧)构建局部地图nearHistorySurfKeyFrameCloudDS，局部地图是由lessSharp与lessFlat点集构成的;</li>
<li>将这个局部地图Publish出去用于可视化。</li>
</ol>
<p>经过这个函数，可以找到当前帧对应的历史回环帧，<code>performLoopClosure()</code>函数之后对latestSurfKeyFrameCloud点云向nearHistorySurfKeyFrameCloudDS点云进行ICP配准。如果ICP配准收敛并且ICP配准得分大于最低阈值（0.3），则认为回环成功，将回环约束添加到因子图中，增量式更新ISAM2。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果ICP配准没有收敛或ICP配准得分大于最低阈值（0.3）</span></span><br><span class="line"><span class="keyword">if</span> (icp.hasConverged() == <span class="literal">false</span> || icp.getFitnessScore() &gt; historyKeyframeFitnessScore)</span><br><span class="line">   <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>

<p><font color=red>这里闭环约束的添加感觉有点问题!</font></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> x, y, z, roll, pitch, yaw;</span><br><span class="line">Eigen::Affine3f correctionCameraFrame = icp.getFinalTransformation();</span><br><span class="line"><span class="comment">// roll--&gt;transformTobeMapped[0]; pitch --&gt; transformTobeMapped[1]; yaw --&gt; transformTobeMapped[2]</span></span><br><span class="line">pcl::getTranslationAndEulerAngles(correctionCameraFrame, x, y, z, roll, pitch, yaw);</span><br><span class="line"><span class="comment">// 这里变换为saveKeyFramesAndFactor()函数中ISAM2对应的Pose3格式，旋转是R = Rz(pitch) * Ry(roll) * Rx(yaw)</span></span><br><span class="line">Eigen::Affine3f correctionLidarFrame = pcl::getTransformation(z, x, y, yaw, roll, pitch); </span><br><span class="line">Eigen::Affine3f tWrong = pclPointToAffine3fCameraToLidar(cloudKeyPoses6D-&gt;points[latestFrameIDLoopCloure]);    </span><br><span class="line"><span class="comment">// 这个的误差构造感觉有点问题，tCorrect = T_&#123;cur&#125;^&#123;loop&#125; * T_&#123;cur&#125;^&#123;world&#125;</span></span><br><span class="line">Eigen::Affine3f tCorrect = correctionLidarFrame * tWrong;</span><br><span class="line">pcl::getTranslationAndEulerAngles(tCorrect, x, y, z, roll, pitch, yaw);</span><br><span class="line"><span class="comment">// poseFrom = T_&#123;cur&#125;^&#123;loop&#125; * T_&#123;cur&#125;^&#123;world&#125;</span></span><br><span class="line">gtsam::Pose3 poseFrom = Pose3(Rot3::RzRyRx(roll, pitch, yaw), Point3(x, y, z));</span><br><span class="line"><span class="comment">// poseTo = T_&#123;loop&#125;^&#123;world&#125;</span></span><br><span class="line">gtsam::Pose3 poseTo = pclPointTogtsamPose3(cloudKeyPoses6D-&gt;points[closestHistoryFrameID]);</span><br><span class="line"><span class="function">gtsam::Vector <span class="title">Vector6</span><span class="params">(<span class="number">6</span>)</span></span>;</span><br><span class="line"><span class="keyword">float</span> noiseScore = icp.getFitnessScore();</span><br><span class="line">Vector6 &lt;&lt; noiseScore, noiseScore, noiseScore, noiseScore, noiseScore, noiseScore;</span><br><span class="line">constraintNoise = noiseModel::Diagonal::Variances(Vector6);                                <span class="comment">// 噪声标准差    </span></span><br><span class="line"><span class="comment">// poseFrom.between(poseTo) = poseFrom^&#123;-1&#125; poseTo</span></span><br><span class="line"><span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;                                                     <span class="comment">// poseFrom^&#123;-1&#125;*poseTo</span></span><br><span class="line">gtSAMgraph.add(BetweenFactor&lt;Pose3&gt;(latestFrameIDLoopCloure, closestHistoryFrameID, poseFrom.between(poseTo), constraintNoise));</span><br></pre></td></tr></table></figure>

<h3 id="3、可视化线程"><a href="#3、可视化线程" class="headerlink" title="3、可视化线程"></a>3、可视化线程</h3><p>可视化线程5s调用一次<code>publishGlobalMap()</code>函数，此函数发布距离当前位置currentRobotPosPoint半径globalMapVisualizationSearchRadius内的所有关键帧位姿点云和地图点云，globalMapVisualizationSearchRadius足够大，可以发布整张地图。并且可视化线程还将这个地图保存到硬盘中，也保存所有关键帧的LessSharp点云，LessFlat点云+outlier点云到硬盘。</p>
<h3 id="想要获取比较稠密的点云地图怎么去改"><a href="#想要获取比较稠密的点云地图怎么去改" class="headerlink" title="想要获取比较稠密的点云地图怎么去改"></a>想要获取比较稠密的点云地图怎么去改</h3><ol>
<li>在featureAssociation节点的<code>publishCloudsLast()</code>函数中取消点云发布频率的限制；</li>
<li>在mapOptmization节点将接收到的消息缓存在queue中，这样不会出现丢帧，进而可以选择是否处理每一帧；</li>
<li>在mapOptmization节点的saveKeyFramesAndFactor()函数中将关键帧距离阈值调小；</li>
</ol>
<h3 id="可以优化的点"><a href="#可以优化的点" class="headerlink" title="可以优化的点"></a>可以优化的点</h3><ol>
<li>次极小平面点集与外点点集的参考坐标不一致，可以在featureAssociation节点加入对outlier点云的去畸变+投影的过程；</li>
<li>将历史关键帧缓存到硬盘而不是一直缓存在内存。<code>saveKeyFramesAndFactor()</code>保存了所有关键帧的信息以用来回环检测，尽管这里只是把智能指针push_back进去vector容器，但是指针所指之内存不会被释放。小场景下不会出问题，大场景下会占用过多的内存。（PS：尽管程序自己会用SWap，但是就是感觉不爽。）</li>
<li>Lego-LOAM的回环检测还是比较粗糙It often fails when the odometry drift is too large.参考这个<a href="https://github.com/irapkaist/SC-LeGO-LOAM" target="_blank" rel="noopener">SC-LeGO-LOAM</a>]</li>
</ol>
<h3 id="潜在的问题"><a href="#潜在的问题" class="headerlink" title="潜在的问题"></a>潜在的问题</h3><p><strong>这一部分是我推导出来的结果，后续我会一一验证，暂时罗列出来给自己做一个标记！</strong></p>
<ol>
<li><code>transformAssociateToMap()</code>函数中对平移量初始值的赋予；</li>
<li><code>performLoopClosure()</code>函数中添加的回环约束项；</li>
</ol>

    </div>

    
    
    
        <div class="reward-container">
  <div>听说打赏我的人，最后都找到了真爱。</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/%E5%BE%AE%E4%BF%A1.jpg" alt="陌上&烟雨 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/%E6%94%AF%E4%BB%98%E5%AE%9D.jpg" alt="陌上&烟雨 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SLAM/" rel="tag"># SLAM</a>
              <a href="/tags/LeGo-LOAM/" rel="tag"># LeGo-LOAM</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/07/31/LeGo-LOAM%E4%B8%AD%E7%9A%84ImageProjection%E8%8A%82%E7%82%B9/" rel="prev" title="LeGo-LOAM中的ImageProjection节点">
      <i class="fa fa-chevron-left"></i> LeGo-LOAM中的ImageProjection节点
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#LeGo-LOAM中的mapOptmization节点"><span class="nav-text">LeGo-LOAM中的mapOptmization节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#这个模块接收5种消息"><span class="nav-text">这个模块接收5种消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#这个模块有三个线程"><span class="nav-text">这个模块有三个线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1、主线程"><span class="nav-text">1、主线程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1、transformAssociateToMap"><span class="nav-text">1.1、transformAssociateToMap()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2、extractSurroundingKeyFrames"><span class="nav-text">1.2、extractSurroundingKeyFrames()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3、scan2MapOptimization"><span class="nav-text">1.3、scan2MapOptimization()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4、saveKeyFramesAndFactor"><span class="nav-text">1.4、saveKeyFramesAndFactor()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5、correctPoses"><span class="nav-text">1.5、correctPoses()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-6、发布全局位姿、相关点云"><span class="nav-text">1.6、发布全局位姿、相关点云</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、回环检测线程"><span class="nav-text">2、回环检测线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、可视化线程"><span class="nav-text">3、可视化线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#想要获取比较稠密的点云地图怎么去改"><span class="nav-text">想要获取比较稠密的点云地图怎么去改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#可以优化的点"><span class="nav-text">可以优化的点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#潜在的问题"><span class="nav-text">潜在的问题</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="陌上&烟雨"
      src="/images/%E5%A4%B4%E5%83%8F.jpeg">
  <p class="site-author-name" itemprop="name">陌上&烟雨</p>
  <div class="site-description" itemprop="description">这知识，它不进脑子啊！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Gutsgwh1997" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Gutsgwh1997" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:guanwenhaohit@gmail.com" title="E-Mail → mailto:guanwenhaohit@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/%E8%81%94%E7%B3%BB%E6%96%B9%E5%BC%8F.jpg" title="WeChat → &#x2F;images&#x2F;联系方式.jpg"><i class="fa fa-fw fa-wechat"></i>WeChat</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://github.com/YiChenCityU/Recent_SLAM_Research" title="https:&#x2F;&#x2F;github.com&#x2F;YiChenCityU&#x2F;Recent_SLAM_Research" rel="noopener" target="_blank">SLAM前沿</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://leetcode.com/" title="https:&#x2F;&#x2F;leetcode.com&#x2F;" rel="noopener" target="_blank">LeetCode</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://github.com/daohu527/Dig-into-Apollo" title="https:&#x2F;&#x2F;github.com&#x2F;daohu527&#x2F;Dig-into-Apollo" rel="noopener" target="_blank">百度Apollo笔记</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">陌上&烟雨</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">189k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">2:52</span>
</div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  











<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
